dist: xenial
language: python
python:
- '2.7'
- '3.5'
- '3.6'
- '3.7'
- '3.8'
cache:
  pip: true
env:
- TEST_SUITE=unittest CMAKE_BUILD_TYPE=Release PRJ_COMPILER=gcc
jobs:
  include:
  - env: TEST_SUITE=cppcheck
  - env: TEST_SUITE=buildwheels DOCKER_IMAGE=quay.io/pypa/manylinux2010_x86_64
    sudo: required
    services:
      - docker
addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    packages:
    - python-dev
    - python-numpy
    - valgrind
    - cppcheck
    - memcached
    - libmemcached11
    - golang
    - g++
install:
- pip install --upgrade pip setuptools future
- if [[ $TEST_SUITE = "unittest" ]]; then pip install pytest greenify gevent; fi
- if [[ $TEST_SUITE = "benchmark" ]]; then pip install python-memcached pylibmc; fi
before_script:
- if [[ $TEST_SUITE != "cppcheck" && $TEST_SUITE != "buildwheels" ]]; then ./misc/memcached_server start; fi
script:
- if [[ $PRJ_COMPILER = "gcc" ]]; then export CC=gcc CXX=g++; fi
- if [[ $PRJ_COMPILER = "clang" ]]; then export CC=clang CXX=clang++; fi
- "./misc/travis/$TEST_SUITE.sh"
after_script:
- if [[ $TEST_SUITE != "cppcheck" && $TEST_SUITE != "buildwheels" ]]; then ./misc/memcached_server stop; fi
deploy:
  provider: pypi
  skip_existing: true
  username: __token__
  password: $PYPI_TOKEN
  on:
    tags: true
    repo: douban/libmc
    branch: master
    condition: $TEST_SUITE = "buildwheels"
